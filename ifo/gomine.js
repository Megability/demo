const ethers = require('ethers');

const abi = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"roll","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"minePower","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"planet","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"experience","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fleetLevel","type":"uint256"}],"name":"eventGoMine","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"},{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint32","name":"_amount","type":"uint32"}],"name":"addFuel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_fleetOwner","type":"address"},{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint256[]","name":"_workersId","type":"uint256[]"},{"internalType":"uint256[]","name":"_spaceshipsId","type":"uint256[]"}],"name":"addToFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"},{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint32","name":"_currentDay","type":"uint32"}],"name":"burnFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"},{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint8","name":"_uses","type":"uint8"}],"name":"contractFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getInitialFleetLevel","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"}],"name":"getMyFleets","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"}],"name":"getTokenDetails","outputs":[{"components":[{"internalType":"uint8","name":"maxWorkers","type":"uint8"},{"internalType":"uint8","name":"rank","type":"uint8"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint8","name":"contractUses","type":"uint8"},{"internalType":"uint16","name":"minePower","type":"uint16"},{"internalType":"uint32","name":"fuel","type":"uint32"},{"internalType":"uint32","name":"experience","type":"uint32"},{"internalType":"uint32","name":"lastMineDay","type":"uint32"},{"internalType":"string","name":"customName","type":"string"},{"internalType":"uint256[]","name":"fleetWorkers","type":"uint256[]"},{"internalType":"uint256[]","name":"fleetSpaceships","type":"uint256[]"},{"internalType":"uint8","name":"faction","type":"uint8"},{"internalType":"uint16","name":"lootBox","type":"uint16"}],"internalType":"struct Fleet.FleetStruct","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"},{"internalType":"uint256","name":"_fleetTokenId","type":"uint256"},{"internalType":"uint256","name":"_planet","type":"uint256"},{"internalType":"uint32","name":"_currentDay","type":"uint32"},{"internalType":"uint8","name":"_mpRequiredPerMine","type":"uint8"}],"name":"goMine","outputs":[{"internalType":"uint256","name":"_roll","type":"uint256"},{"internalType":"uint256","name":"_winChance","type":"uint256"},{"internalType":"uint256","name":"_rewards","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint32","name":"_experience","type":"uint32"},{"internalType":"uint8","name":"_level","type":"uint8"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract Spaceship","name":"_spaceships","type":"address"},{"internalType":"contract Worker","name":"_workers","type":"address"},{"internalType":"contract Fleet","name":"_fleets","type":"address"},{"internalType":"contract Progression","name":"_progression","type":"address"},{"internalType":"contract Planet","name":"_planets","type":"address"},{"internalType":"contract Oracle","name":"_oracle","type":"address"},{"internalType":"contract VRFChainlink","name":"_vrfChainlink","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_minter","type":"address"},{"internalType":"uint256[]","name":"_workersId","type":"uint256[]"},{"internalType":"uint256[]","name":"_spaceshipsId","type":"uint256[]"},{"internalType":"string","name":"_fleetName","type":"string"}],"name":"mintFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"onERC721Received","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_level","type":"uint8"}],"name":"setInitialFleetLevel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}];

const abi2 = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"eventBurnSpaceship","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"eventBurnWorker","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint32","name":"fuel","type":"uint32"},{"indexed":false,"internalType":"uint256","name":"cost","type":"uint256"},{"indexed":false,"internalType":"bool","name":"fromUnclaimed","type":"bool"}],"name":"eventBuyFuel","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"fleetOwner","type":"address"},{"indexed":false,"internalType":"uint256","name":"fleetTokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewards","type":"uint256"},{"indexed":false,"internalType":"uint32","name":"fuelRewards","type":"uint32"},{"indexed":false,"internalType":"uint8","name":"level","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"experience","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"place","type":"uint8"},{"indexed":false,"internalType":"bool","name":"winLootBox","type":"bool"}],"name":"eventClaimRaidRewards","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"claimedAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"claimedFee","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"}],"name":"eventClaimRewards","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"uses","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"cost","type":"uint256"},{"indexed":false,"internalType":"bool","name":"fromUnclaimed","type":"bool"}],"name":"eventContractWorker","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256[]","name":"_workersId","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"_spaceshipsId","type":"uint256[]"},{"indexed":false,"internalType":"string","name":"_fleetName","type":"string"},{"indexed":false,"internalType":"bool","name":"_useTokenRewards","type":"bool"},{"indexed":false,"internalType":"uint256","name":"cost","type":"uint256"}],"name":"eventCreateFleet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"roll","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winChance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"minePower","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"planet","type":"uint256"},{"indexed":false,"internalType":"uint32","name":"experience","type":"uint32"},{"indexed":false,"internalType":"uint8","name":"fleetLevel","type":"uint8"}],"name":"eventGoMine","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"enum CryptoMines.nftTypeText","name":"nftType","type":"uint8"},{"indexed":false,"internalType":"address","name":"minter","type":"address"}],"name":"eventQueueMint","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"enum CryptoMines.nftTypeText","name":"nftType","type":"uint8"},{"indexed":false,"internalType":"address","name":"minter","type":"address"}],"name":"eventRevealNFT","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint32","name":"_units","type":"uint32"},{"internalType":"bool","name":"_useTokenRewards","type":"bool"}],"name":"addFuelToFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint256[]","name":"_workersId","type":"uint256[]"},{"internalType":"uint256[]","name":"_spaceshipsId","type":"uint256[]"},{"internalType":"bool","name":"_useTokenRewards","type":"bool"}],"name":"addToFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"approveEternal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"}],"name":"burnFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_spaceshipId","type":"uint256"}],"name":"burnSpaceship","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_workerId","type":"uint256"}],"name":"burnWorker","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_fleetTokenId","type":"uint256"}],"name":"claimRaidRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimTokenRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_tokenId","type":"uint256"},{"internalType":"uint8","name":"_uses","type":"uint8"},{"internalType":"bool","name":"_useTokenRewards","type":"bool"}],"name":"contractFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getContractCostEternal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentDay","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDaysForClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getFleetMintCostPerNftEternal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getFuelCostEternal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxSpaceships","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxWorkers","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinePower","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMintCostEternal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMySpaceships","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyTimeForClaim","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyWorkers","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_address","type":"address"}],"name":"getTokenRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_fleetTokenId","type":"uint256"},{"internalType":"uint256","name":"_planet","type":"uint256"}],"name":"goMine","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_fleetTokenId","type":"uint256"},{"internalType":"uint8","name":"_planet","type":"uint8"}],"name":"goRaid","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"increaseCurrentDay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"_eternalToken","type":"address"},{"internalType":"contract Spaceship","name":"_spaceship","type":"address"},{"internalType":"contract Worker","name":"_workers","type":"address"},{"internalType":"contract Oracle","name":"_oracle","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"_workersId","type":"uint256[]"},{"internalType":"uint256[]","name":"_spaceshipsId","type":"uint256[]"},{"internalType":"string","name":"_fleetName","type":"string"},{"internalType":"bool","name":"_useTokenRewards","type":"bool"}],"name":"mintFleet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"enum CryptoMines.nftTypeText","name":"_nftType","type":"uint8"}],"name":"queueMint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"enum CryptoMines.nftTypeText","name":"_nftType","type":"uint8"}],"name":"revealNFT","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_seedAllocator","type":"address"}],"name":"seedGasFunder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract FleetFunctions","name":"_fleetFunctions","type":"address"}],"name":"setFleetFunctionsContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_wei","type":"uint256"}],"name":"setFleetMintCostPerNftInWei","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_wei","type":"uint256"}],"name":"setFuelUnitCostInWei","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract Raid","name":"_raids","type":"address"}],"name":"setRaidsContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"usdToEternal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

// Connect to the network
const url = 'https://bsc-dataseed1.binance.org';
const provider = new ethers.providers.JsonRpcProvider(url);

// 地址来自上面部署的合约
const contractAddress = "0x23C3dAd5D9a0dB066082311B61eAc5AffC92dd16";
const contractAddress2 = "0x6778f69f83c7d42612500efe0bcd278c112688f6";

// 使用Provider 连接合约，将只有对合约的可读权限
const contract = new ethers.Contract(contractAddress, abi, provider);
const contract2 = new ethers.Contract(contractAddress2, abi2, provider);


//console.log(contract);
//console.log(contract2);


async function goMine(obj) {
    const responseMyFleets = await contract.getMyFleets(obj.addr);

    let wallet = new ethers.Wallet(obj.s, provider);

    let contractWithSigner = contract2.connect(wallet);

    let overrides = {
        // The maximum units of gas for the transaction to use
        gasLimit: 460000,
        // The price (in wei) per unit of gas
        gasPrice: ethers.utils.parseUnits('5.0', 'gwei'),
        // The nonce to use in the transaction
        //nonce: 123,
        // The amount to send with the transaction (i.e. msg.value)
        //value: ethers.utils.parseEther('1.0'),
        // The chain ID (or network ID) to use
        //chainId: 1
    };
    for(j = 0; j < responseMyFleets.length; j++) {
        //console.log(responseMyFleets[j].toString());
        const responseTokenDetails = await contract.getTokenDetails(responseMyFleets[j].toString())
        let mp = responseTokenDetails[4];
        //console.log(parseInt(mp/100))
        let tx = await contractWithSigner.goMine(responseMyFleets[j].toString(), parseInt(mp/100), overrides);
        console.log(tx.hash);
        await tx.wait();
    }
    return await responseMyFleets
}
//并行
const start = async () => {

    const wallets = require('./config');

    console.time('goMine');
    const promises = wallets.map(x => goMine(x));
    for (const promise of promises) {
        try{
            const data = await promise;
            console.log(`Data: ${data}`);
        } catch (err) {
            console.error(err)
        }
    }
    console.timeEnd('goMine');

}

start();